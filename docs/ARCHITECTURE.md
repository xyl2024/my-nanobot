# ğŸ—ï¸ nanobot é¡¹ç›®æ¶æ„è¯¦ç»†åˆ†æ

> ç”Ÿæˆæ—¶é—´: 2026-02-22
> ä½œè€…: å°è¯º (Xiao Nuo)

---

## ä¸€ã€æ•´ä½“æ¶æ„æ¦‚è§ˆ

nanobot é‡‡ç”¨ **äº‹ä»¶é©±åŠ¨ + æ¶ˆæ¯æ€»çº¿** çš„æ¶æ„æ¨¡å¼ï¼Œæ ¸å¿ƒæ˜¯ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦æ¶ˆæ¯æ”¶å‘åŒæ–¹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           nanobot æ¶æ„å›¾                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚   CLI å‘½ä»¤   â”‚                    â”‚     Gateway (HTTP Server)    â”‚ â”‚
â”‚   â”‚ (commands)  â”‚                    â”‚       (ç«¯å£ 18790)          â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                                            â”‚                â”‚
â”‚          â–¼                                            â–¼                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                    MessageBus (æ¶ˆæ¯æ€»çº¿)                     â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚   â”‚  â”‚  inbound Queue  â”‚         â”‚   outbound Queue        â”‚   â”‚    â”‚
â”‚   â”‚  â”‚  (å…¥ç«™æ¶ˆæ¯)      â”‚         â”‚   (å‡ºç«™æ¶ˆæ¯)             â”‚   â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚               â”‚                                 â”‚                    â”‚
â”‚               â–¼                                 â–¼                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚    ChannelManager    â”‚         â”‚      AgentLoop           â”‚   â”‚
â”‚   â”‚    (æ¸ é“ç®¡ç†å™¨)        â”‚         â”‚      (Agent æ ¸å¿ƒ)        â”‚   â”‚
â”‚   â”‚                       â”‚         â”‚                          â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”     â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚TG â”‚ â”‚DC  â”‚ ...â”‚     â”‚         â”‚  â”‚  1. æ¥æ”¶æ¶ˆæ¯        â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜     â”‚         â”‚  â”‚  2. æ„å»º Context    â”‚  â”‚   â”‚
â”‚   â”‚   9+ æ¸ é“            â”‚         â”‚  â”‚  3. è°ƒç”¨ LLM        â”‚  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚  4. æ‰§è¡Œ Tools     â”‚  â”‚   â”‚
â”‚               â”‚                   â”‚  â”‚  5. è¿”å›å“åº”        â”‚  â”‚   â”‚
â”‚               â”‚                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚               â”‚                   â”‚             â”‚             â”‚   â”‚
â”‚               â”‚    ç”¨æˆ·æ¶ˆæ¯         â”‚             â”‚ AI å“åº”      â”‚   â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. æ¶ˆæ¯æ€»çº¿ (Message Bus) ğŸ”Œ

**ä½ç½®**: `nanobot/bus/`

```python
# æ¶ˆæ¯ç±»å‹å®šä¹‰
InboundMessage  â”€â”€â”€â”€â”€â”€â”
  - channel: str     â”‚    # æ¥è‡ªå“ªä¸ªæ¸ é“ (telegram, discord, feishu...)
  - sender_id: str   â”‚    # å‘é€è€… ID
  - chat_id: str     â”‚    # ä¼šè¯ ID
  - content: str     â”‚
  - media: list      â”‚    # å›¾ç‰‡/æ–‡ä»¶
  - metadata: dict   â”˜

OutboundMessage â”€â”€â”€â”€â”€â”
  - channel: str    â”‚
  - chat_id: str    â”‚
  - content: str    â”‚
  - media: list     â”˜
```

**æ¶ˆæ¯æµ**:
```
Channel (æ¥æ”¶)  â”€â”€publish_inbound()â”€â”€â–¶  inbound Queue  â”€â”€consume_inbound()â”€â”€â–¶ AgentLoop
                                                                              â”‚
AgentLoop  â”€â”€publish_outbound()â”€â”€â–¶  outbound Queue  â”€â”€consume_outbound()â”€â”€â–¶  Channel (å‘é€)
```

---

### 2. æ¸ é“å±‚ (Channels) ğŸ“±

**ä½ç½®**: `nanobot/channels/`

| æ¸ é“ | æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| Telegram | `telegram.py` | âœ… | Bot API |
| Discord | `discord.py` | âœ… | Gateway API |
| WhatsApp | `whatsapp.py` | âœ… | éœ€æ¡¥æ¥æœåŠ¡ |
| é£ä¹¦ | `feishu.py` | âœ… | WebSocket é•¿è¿æ¥ |
| é’‰é’‰ | `dingtalk.py` | âœ… | Stream æ¨¡å¼ |
| Slack | `slack.py` | âœ… | Socket æ¨¡å¼ |
| QQ | `qq.py` | âœ… | botpy SDK |
| Email | `email.py` | âœ… | IMAP + SMTP |
| MoChat | `mochat.py` | âœ… | ä¼ä¸šå¾®ä¿¡æ–¹æ¡ˆ |

**æ¯ä¸ªæ¸ é“éœ€å®ç°**:
```python
class BaseChannel(ABC):
    async def start() -> None      # å¯åŠ¨ç›‘å¬
    async def stop() -> None        # åœæ­¢
    async def send(msg) -> None     # å‘é€æ¶ˆæ¯
    def is_allowed(sender_id) -> bool  # æƒé™æ£€æŸ¥
```

---

### 3. Agent æ ¸å¿ƒ (Agent Loop) ğŸ§ 

**ä½ç½®**: `nanobot/agent/loop.py` (çº¦ 418 è¡Œ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AgentLoop.run() æµç¨‹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   while running:                                            â”‚
â”‚     1. msg = await bus.consume_inbound()                   â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚     2. session = sessions.get_or_create(session_key)        â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚     3. messages = context.build_messages(                  â”‚
â”‚           history=session.get_history(),                   â”‚
â”‚           current_message=msg.content                      â”‚
â”‚        )                                                    â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚     4. _run_agent_loop(messages)                           â”‚
â”‚        â”‚                                                    â”‚
â”‚        â”œâ”€â–¶ LLM.chat() â”€â”€â–¶ å“åº”                              â”‚
â”‚        â”‚         â”‚                                          â”‚
â”‚        â”‚         â–¼                                          â”‚
â”‚        â”‚    æœ‰ Tool Calls?                                   â”‚
â”‚        â”‚       â”œâ”€ Yes â”€â”€â–¶ æ‰§è¡Œ Tools â”€â”€â–¶ æ·»åŠ ç»“æœ â”€â”€â–¶ ç»§ç»­ â”‚
â”‚        â”‚       â”‚                                            â”‚
â”‚        â”‚       â””â”€ No â”€â”€â–¶ è¿”å›æœ€ç»ˆå“åº”                        â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚     5. session.add_message(user, msg.content)              â”‚
â”‚        session.add_message(assistant, response)             â”‚
â”‚        sessions.save(session)                               â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚     6. await bus.publish_outbound(response)                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4. ä¸Šä¸‹æ–‡æ„å»º (Context Builder) ğŸ“

**ä½ç½®**: `nanobot/agent/context.py`

æ„å»ºç»™ LLM çš„å®Œæ•´ promptï¼š

```python
system_prompt = """
# 1. åŸºæœ¬æè¿° (å†…ç½®)
   - å½“å‰æ—¶é—´ã€è¿è¡Œç¯å¢ƒã€å·¥ä½œç©ºé—´
   - å¯ç”¨å·¥å…·åˆ—è¡¨

# 2. Bootstrap æ–‡ä»¶ (workspace/)
   - SOUL.md - AI äººæ ¼è®¾å®š
   - USER.md - ç”¨æˆ·ä¿¡æ¯

# 3. é•¿æœŸè®°å¿† (memory/)
   - MEMORY.md - è·¨ä¼šè¯æŒä¹…åŒ–çš„é‡è¦ä¿¡æ¯

# 4. æŠ€èƒ½ (skills/)
   - å·²åŠ è½½çš„æŠ€èƒ½ (å®Œæ•´å†…å®¹)
   - å¯ç”¨æŠ€èƒ½ (ä»…æ‘˜è¦ï¼Œéœ€ä¸»åŠ¨è¯»å–)

# 5. å½“å‰ä¼šè¯ä¿¡æ¯
   - Channel: feishu
   - Chat ID: oc_xxx
"""
```

---

### 5. è®°å¿†ç³»ç»Ÿ (Memory) ğŸ§¬

**ä½ç½®**: `nanobot/agent/memory.py`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åŒå±‚è®°å¿†ç³»ç»Ÿ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Layer 1: MEMORY.md (é•¿æœŸè®°å¿†)                      â”‚
â”‚  - LLM æ€»ç»“çš„é‡è¦äº‹å®ã€åå¥½ã€ç¬”è®°                     â”‚
â”‚  - grep å‹å¥½ï¼Œå¯è¢«ç›´æ¥è¯»å–                            â”‚
â”‚                                                     â”‚
â”‚  Layer 2: HISTORY.md (å†å²è®°å½•)                      â”‚
â”‚  - æŒ‰æ—¶é—´æ’åˆ—çš„äº‹ä»¶æ—¥å¿—                              â”‚
â”‚  - æ ¼å¼: [YYYY-MM-DD HH:MM] äº‹ä»¶æè¿°                â”‚
â”‚  - å¯ç”¨ grep æœç´¢                                    â”‚
â”‚                                                     â”‚
â”‚  æœºåˆ¶:                                              â”‚
â”‚  - æ¯éš” memory_window (50) æ¡æ¶ˆæ¯è§¦å‘åˆå¹¶            â”‚
â”‚  - LLM è°ƒç”¨ save_memory å·¥å…·è¿›è¡Œæ€»ç»“                 â”‚
â”‚  - æ—§æ¶ˆæ¯å½’æ¡£åˆ° HISTORYï¼Œæ ¸å¿ƒä¿¡æ¯å†™å…¥ MEMORY         â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6. å·¥å…·ç³»ç»Ÿ (Tools) ğŸ”§

**ä½ç½®**: `nanobot/agent/tools/`

| å·¥å…· | åŠŸèƒ½ | ä¾èµ– |
|------|------|------|
| `web_search` | ç½‘ç»œæœç´¢ (Tavily) | tavily |
| `web_fetch` | è·å–ç½‘é¡µå†…å®¹ | httpx, readability |
| `shell` | æ‰§è¡Œ Shell å‘½ä»¤ | - |
| `spawn` | ç”Ÿæˆå­ä»£ç† | - |
| `mcp` | MCP å·¥å…·è°ƒç”¨ | mcp åº“ |
| `cron` | å®šæ—¶ä»»åŠ¡ | - |
| `filesystem` | æ–‡ä»¶æ“ä½œ | - |

**å·¥å…·æ³¨å†Œæµç¨‹**:
```python
# agent/loop.py åˆå§‹åŒ–æ—¶
tools = ToolRegistry()
tools.register(WebSearchTool(api_key=...))
tools.register(WebFetchTool())
tools.register(ShellTool(timeout=60))
tools.register(SpawnTool())
tools.register(CronTool())
tools.register(MCPTools(servers=...))
```

---

### 7. LLM æä¾›å•† (Providers) ğŸ¤–

**ä½ç½®**: `nanobot/providers/`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Provider æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   LLMProvider (ABC)                                        â”‚
â”‚       â”‚                                                    â”‚
â”‚       â”œâ”€â”€ LiteLLMProvider â”€â”€â–¶ ç»Ÿä¸€åŒ…è£… 20+ LLM             â”‚
â”‚       â”‚                                                    â”‚
â”‚       â”œâ”€â”€ CustomProvider â”€â”€â–¶ ç›´è¿ OpenAI å…¼å®¹ç«¯ç‚¹          â”‚
â”‚       â”‚                                                    â”‚
â”‚       â””â”€â”€ OpenAICodexProvider â”€â”€â–¶ OAuth è®¤è¯              â”‚
â”‚                                                             â”‚
â”‚   é€šè¿‡ registry.py è‡ªåŠ¨åŒ¹é…æ¨¡å‹åˆ°æä¾›å•†:                     â”‚
â”‚   - anthropic/claude-3  â”€â”€â–¶ Anthropic                    â”‚
â”‚   - deepseek/deepseek-chat â”€â”€â–¶ DeepSeek                   â”‚
â”‚   - qwen/qwen-max â”€â”€â–¶ DashScope (é˜¿é‡Œäº‘)                  â”‚
â”‚   - kimi-k2.5 â”€â”€â–¶ Moonshot (æœˆä¹‹æš—é¢)                     â”‚
â”‚   - glm-4 â”€â”€â–¶ Zhipu (æ™ºè°±)                                â”‚
â”‚   - sk-or-xxx â”€â”€â–¶ OpenRouter (ç½‘å…³)                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¯æŒçš„ LLM æä¾›å•†** (via LiteLLM):
- **æ ‡å‡†**: OpenAI, Anthropic, DeepSeek, Gemini
- **å›½å†…**: DashScope (é€šä¹‰åƒé—®), Moonshot (æœˆä¹‹æš—é¢), MiniMax, Zhipu (æ™ºè°±)
- **ç½‘å…³**: OpenRouter, AiHubMix, SiliconFlow, VolcEngine (ç«å±±å¼•æ“)
- **æœ¬åœ°**: vLLM, Ollama

---

### 8. ä¼šè¯ç®¡ç† (Session) ğŸ’¬

**ä½ç½®**: `nanobot/session/manager.py`

```python
# ä¼šè¯ç»“æ„
Session:
  key: str           # "channel:chat_id" å¦‚ "telegram:123456"
  messages: list     # æ¶ˆæ¯åˆ—è¡¨ (role, content, timestamp, tools_used)
  created_at: datetime
  updated_at: datetime
  metadata: dict
  last_consolidated: int  # å·²åˆå¹¶çš„æ¶ˆæ¯æ•°

# å­˜å‚¨æ ¼å¼: JSONL
# ~/.nanobot/workspace/sessions/telegram_123456.jsonl
```

---

### 9. å®šæ—¶ä»»åŠ¡ (Cron) â°

**ä½ç½®**: `nanobot/cron/service.py`

```python
# æ”¯æŒçš„è°ƒåº¦æ–¹å¼
- every N ç§’ (every_ms)
- Cron è¡¨è¾¾å¼ (expr + timezone)
- ä¸€æ¬¡æ€§æ‰§è¡Œ (at_ms)

# ç¤ºä¾‹
nanobot cron add -n "AIæ–°é—»" -m "æœé›†ä»Šæ—¥AIçƒ­ç‚¹" --cron "0 13 * * *" --tz Asia/Shanghai

# å®šæ—¶ä»»åŠ¡ç±»å‹
- æ¶ˆæ¯è§¦å‘ (agent_turn)
- å¯é€‰æŠ•é€’åˆ°æ¸ é“ (deliver=true --to=xxx --channel=telegram)
```

---

### 10. é…ç½®ç³»ç»Ÿ (Config) âš™ï¸

**ä½ç½®**: `nanobot/config/schema.py`

ä½¿ç”¨ Pydantic + pydantic-settings:

```python
Config:
  â”œâ”€â”€ agents: AgentsConfig
  â”‚     â””â”€â”€ defaults: model, max_tokens, temperature, memory_window
  â”‚
  â”œâ”€â”€ channels: ChannelsConfig
  â”‚     â”œâ”€â”€ telegram, discord, whatsapp
  â”‚     â”œâ”€â”€ feishu, dingtalk, slack
  â”‚     â”œâ”€â”€ qq, email, mochat
  â”‚
  â”œâ”€â”€ providers: ProvidersConfig
  â”‚     â”œâ”€â”€ openai, anthropic, deepseek
  â”‚     â”œâ”€â”€ dashscope, moonshot, minimax, zhipu
  â”‚     â”œâ”€â”€ openrouter, siliconflow, volcengine
  â”‚     â””â”€â”€ vllm (æœ¬åœ°)
  â”‚
  â”œâ”€â”€ gateway: host, port
  â”‚
  â””â”€â”€ tools: ToolsConfig
        â”œâ”€â”€ web.search (tavily)
        â”œâ”€â”€ exec (shell timeout)
        â””â”€â”€ mcp_servers (dict)
```

**é…ç½®åŠ è½½ä¼˜å…ˆçº§**:
1. ç¯å¢ƒå˜é‡ (`NANOBOT_xxx`)
2. `~/.nanobot/config.json`
3. é»˜è®¤å€¼

---

## ä¸‰ã€æ•°æ®æµå…¨æ™¯å›¾

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Channel (å¦‚ Feishu)         â”‚
â”‚  - æ¥æ”¶æ¶ˆæ¯                  â”‚
â”‚  - æƒé™æ£€æŸ¥ is_allowed()     â”‚
â”‚  - è½¬æ¢ä¸º InboundMessage     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ bus.publish_inbound(msg)
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageBus (inbound queue)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ await bus.consume_inbound()
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AgentLoop._process_message â”‚
â”‚                              â”‚
â”‚  1. è·å–/åˆ›å»º Session        â”‚
â”‚  2. æ„å»º Context (ç³»ç»Ÿæç¤º+  â”‚
â”‚     å†å²æ¶ˆæ¯+å½“å‰æ¶ˆæ¯)        â”‚
â”‚  3. _run_agent_loop()       â”‚
â”‚     - è°ƒç”¨ LLM               â”‚
â”‚     - æ‰§è¡Œ Tools             â”‚
â”‚     - å¾ªç¯ç›´åˆ°æ—  Tool Call    â”‚
â”‚  4. ä¿å­˜ Session            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ bus.publish_outbound(response)
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageBus (outbound queue)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ ChannelManager._dispatch_outbound()
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Channel.send()              â”‚
â”‚  - å‘é€å“åº”åˆ°ç”¨æˆ·            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”‚
     â–¼
   ç”¨æˆ·æ”¶åˆ°å›å¤ âœ…
```

---

## å››ã€æ‰©å±•å¼€å‘æŒ‡å—

### æ–°å¢ä¸€ä¸ªæ¸ é“ (ä»¥ Slack ä¸ºä¾‹)

```python
# 1. åœ¨ channels/ ä¸‹åˆ›å»º slack.py
from nanobot.channels.base import BaseChannel
from nanobot.bus.events import OutboundMessage

class SlackChannel(BaseChannel):
    name = "slack"
    
    async def start(self):
        # è¿æ¥ Slack WebSocket æˆ–æ³¨å†Œ Webhook
        pass
    
    async def stop(self):
        # æ–­å¼€è¿æ¥
        pass
    
    async def send(self, msg: OutboundMessage):
        # å‘é€æ¶ˆæ¯åˆ° Slack
        pass

# 2. åœ¨ channels/manager.py æ³¨å†Œ
if self.config.channels.slack.enabled:
    from nanobot.channels.slack import SlackChannel
    self.channels["slack"] = SlackChannel(...)
```

### æ–°å¢ä¸€ä¸ªå·¥å…·

```python
# åœ¨ agent/tools/ ä¸‹åˆ›å»º mytool.py
from nanobot.agent.tools.base import Tool

class MyTool(Tool):
    name = "my_tool"
    description = "å·¥å…·æè¿°"
    parameters = {
        "type": "object",
        "properties": {
            "param1": {"type": "string"}
        },
        "required": ["param1"]
    }
    
    async def execute(self, param1: str, **kwargs) -> str:
        # å·¥å…·é€»è¾‘
        return f"Result: {param1}"

# åœ¨ agent/loop.py æ³¨å†Œ
tools.register(MyTool())
```

---

## äº”ã€å…³é”®æŠ€æœ¯äº®ç‚¹

| ç‰¹æ€§ | å®ç°æ–¹å¼ | ä»·å€¼ |
|------|----------|------|
| **æ¶ˆæ¯è§£è€¦** | asyncio.Queue | æ¸ é“å’Œ Agent ç‹¬ç«‹æ¼”è¿› |
| **å¤šæ¸ é“ç»Ÿä¸€** | BaseChannel æŠ½è±¡ | 5 åˆ†é’Ÿæ¥å…¥æ–°æ¸ é“ |
| **å¤š LLM æ”¯æŒ** | LiteLLM ç»Ÿä¸€åŒ…è£… | åˆ‡æ¢æ¨¡å‹æ— æ„ŸçŸ¥ |
| **è®°å¿†æŒä¹…åŒ–** | MEMORY.md + HISTORY.md | é•¿æœŸè®°å¿†ä¸ä¸¢å¤± |
| **å·¥å…·ç”Ÿæ€** | åŠ¨æ€æ³¨å†Œ + MCP | æ‰©å±•èƒ½åŠ›æ— é™ |
| **å®šæ—¶ä»»åŠ¡** | å†…ç½® Cron æœåŠ¡ | è‡ªåŠ¨åŒ–å·¥ä½œæµ |

---

## å…­ã€ä»£ç è§„æ¨¡

- **æ ¸å¿ƒä»£ç **: ~1800 è¡Œ (ä¸å«æ¸ é“å’Œæµ‹è¯•)
- **Agent æ ¸å¿ƒ** (`loop.py`): ~418 è¡Œ
- **æ¸ é“ç®¡ç†** (`manager.py`): ~227 è¡Œ
- **ä¼šè¯ç®¡ç†** (`session/manager.py`): ~200 è¡Œ
- **æ”¯æŒæ¸ é“**: 9 ä¸ª
- **æ”¯æŒ LLM**: 15+

---

## ä¸ƒã€ç›®å½•ç»“æ„æ€»è§ˆ

```
nanobot/
â”œâ”€â”€ agent/                 # Agent æ ¸å¿ƒ
â”‚   â”œâ”€â”€ loop.py           # ä¸»å¾ªç¯ (~418è¡Œ)
â”‚   â”œâ”€â”€ context.py        # ä¸Šä¸‹æ–‡æ„å»º
â”‚   â”œâ”€â”€ memory.py         # è®°å¿†ç³»ç»Ÿ
â”‚   â”œâ”€â”€ tools/            # å·¥å…·é›†
â”‚   â”‚   â”œâ”€â”€ base.py
â”‚   â”‚   â”œâ”€â”€ web_search.py
â”‚   â”‚   â”œâ”€â”€ web_fetch.py
â”‚   â”‚   â”œâ”€â”€ shell.py
â”‚   â”‚   â”œâ”€â”€ spawn.py
â”‚   â”‚   â”œâ”€â”€ cron.py
â”‚   â”‚   â”œâ”€â”€ filesystem.py
â”‚   â”‚   â””â”€â”€ mcp.py
â”‚   â””â”€â”€ registry.py
â”‚
â”œâ”€â”€ channels/             # æ¸ é“å®ç°
â”‚   â”œâ”€â”€ base.py          # BaseChannel æŠ½è±¡
â”‚   â”œâ”€â”€ manager.py       # æ¸ é“ç®¡ç† (~227è¡Œ)
â”‚   â”œâ”€â”€ telegram.py
â”‚   â”œâ”€â”€ discord.py
â”‚   â”œâ”€â”€ feishu.py
â”‚   â”œâ”€â”€ dingtalk.py
â”‚   â”œâ”€â”€ slack.py
â”‚   â”œâ”€â”€ whatsapp.py
â”‚   â”œâ”€â”€ qq.py
â”‚   â”œâ”€â”€ email.py
â”‚   â””â”€â”€ mochat.py
â”‚
â”œâ”€â”€ bus/                  # æ¶ˆæ¯æ€»çº¿
â”‚   â”œâ”€â”€ events.py        # æ¶ˆæ¯ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ queue.py         # asyncio.Queue å°è£…
â”‚
â”œâ”€â”€ providers/           # LLM æä¾›å•†
â”‚   â”œâ”€â”€ base.py          # Provider æŠ½è±¡
â”‚   â”œâ”€â”€ lite_llm.py      # LiteLLM åŒ…è£…
â”‚   â”œâ”€â”€ custom.py        # è‡ªå®šä¹‰ç«¯ç‚¹
â”‚   â””â”€â”€ registry.py      # æ¨¡å‹->æä¾›å•†æ˜ å°„
â”‚
â”œâ”€â”€ session/             # ä¼šè¯ç®¡ç†
â”‚   â”œâ”€â”€ manager.py      # SessionManager (~200è¡Œ)
â”‚   â””â”€â”€ models.py       # Session æ•°æ®æ¨¡å‹
â”‚
â”œâ”€â”€ config/              # é…ç½®ç³»ç»Ÿ
â”‚   â”œâ”€â”€ schema.py       # Pydantic æ¨¡å‹
â”‚   â””â”€â”€ load.py         # é…ç½®åŠ è½½é€»è¾‘
â”‚
â”œâ”€â”€ cron/                # å®šæ—¶ä»»åŠ¡
â”‚   â”œâ”€â”€ service.py      # Cron æœåŠ¡
â”‚   â””â”€â”€ models.py       # ä»»åŠ¡æ¨¡å‹
â”‚
â”œâ”€â”€ commands/            # CLI å‘½ä»¤
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ run.py
â”‚   â”œâ”€â”€ serve.py
â”‚   â”œâ”€â”€ shell.py
â”‚   â””â”€â”€ cron.py
â”‚
â”œâ”€â”€ gateway/             # HTTP ç½‘å…³
â”‚   â””â”€â”€ server.py       # FastAPI æœåŠ¡
â”‚
â”œâ”€â”€ skills/              # å†…ç½®æŠ€èƒ½
â”‚   â”œâ”€â”€ ai-news-fetcher/
â”‚   â””â”€â”€ skill-creator/
â”‚
â””â”€â”€ utils/               # å·¥å…·å‡½æ•°
    â”œâ”€â”€ log.py
    â””â”€â”€ platform.py
```

---

*æ–‡æ¡£æŒç»­æ›´æ–°ä¸­...*
